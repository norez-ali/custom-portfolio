name: Deploy Laravel to Hostinger (PHP 8.4)

on:
  push:
    branches: ["main"] # Change to your branch if different

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout code
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2. Setup PHP 8.4
      # -----------------------------
      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: mbstring, bcmath, intl, pdo_mysql
          tools: composer:v2

      # -----------------------------
      # 3. Install Composer dependencies
      # -----------------------------
      - name: Install Composer dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      # -----------------------------
      # 4. Install Node and build frontend
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install NPM packages
        run: npm ci || true

      - name: Build assets
        run: npm run build || true

      # -----------------------------
      # 5. Prepare deployment folder
      # -----------------------------
      - name: Prepare deploy folder
        run: |
          mkdir deploy
          # Copy all Laravel files to deploy
          rsync -av --exclude=".git" --exclude=".github" ./ deploy/
          # Move public folder content to root
          rsync -av ./public/ ./deploy/
          rm -rf ./deploy/public

      # -----------------------------
      # 6. Clear & cache Laravel config on server (via PHP script)
      # -----------------------------
      - name: Prepare artisan deploy script
        run: |
          echo "<?php
          require __DIR__.'/vendor/autoload.php';
          \$app = require __DIR__.'/bootstrap/app.php';
          \$kernel = \$app->make(Illuminate\Contracts\Console\Kernel::class);
          echo '<pre>';
          \$kernel->call('config:clear');
          \$kernel->call('config:cache');
          \$kernel->call('route:clear');
          \$kernel->call('route:cache');
          \$kernel->call('view:clear');
          \$kernel->call('view:cache');
          echo 'âœ… Laravel caches cleared & rebuilt';
          ?>" > deploy/artisan_deploy.php

      # -----------------------------
      # 7. Upload all files to public_html
      # -----------------------------
      - name: Deploy to Hostinger public_html via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.4.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: deploy
          server-dir: ${{ secrets.FTP_PUBLIC_HTML_PATH }}
