name: Deploy Laravel to Hostinger

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # ---- PHP Setup ----
      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: mbstring, intl, pdo, pdo_mysql
          coverage: none

      # ---- Composer Install ----
      - name: Install Dependencies (Production)
        run: composer install --no-dev --optimize-autoloader

      # ---- Create Safe .env For CI ----
      - name: Create CI environment
        run: |
          cp .env .env.ci
          mv .env.ci .env
          echo "APP_ENV=production" >> .env
          echo "DB_CONNECTION=none" >> .env

      # ---- Laravel Optimization ----
      - name: Laravel Optimize
        run: |
          php artisan config:clear --no-ansi
          php artisan cache:clear --no-ansi
          php artisan view:clear --no-ansi
          php artisan route:clear --no-ansi
          php artisan config:cache --no-ansi
          php artisan route:cache --no-ansi || true
          php artisan view:cache --no-ansi || true

      # ---- Build Deploy Folder ----
      - name: Build Deploy Folder
        run: |
          mkdir deploy
          rsync -av \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="node_modules" \
            --exclude="tests" \
            ./ deploy/

          # Move public folder to root of deploy
          rsync -av ./public/ ./deploy/

          # Remove nested public folder (we already merged it)
          rm -rf ./deploy/public

      # ---- FTP Deployment ----
      - name: Upload to Hostinger public_html
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: 82.198.227.139
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          local-dir: deploy/
          server-dir: public_html/
